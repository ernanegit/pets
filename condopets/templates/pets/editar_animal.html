{% extends 'base.html' %}

{% block title %}Editar {{ animal.nome }} - CondoPets{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-warning text-dark">
                <h4 class="mb-0">
                    <i class="fas fa-edit me-2"></i>Editar {{ animal.nome }}
                </h4>
            </div>
            <div class="card-body">
                <!-- Mostrar foto atual se existir -->
                {% if animal.foto %}
                <div class="text-center mb-4">
                    <img src="{{ animal.foto.url }}" class="img-thumbnail" style="max-height: 200px;" alt="{{ animal.nome }}">
                    <p class="text-muted small mt-2">Foto atual de {{ animal.nome }}</p>
                </div>
                {% endif %}
                
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Nome do Animal</label>
                                {{ form.nome }}
                                {% if form.nome.errors %}
                                    <div class="text-danger small">{{ form.nome.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Tipo</label>
                                {{ form.tipo }}
                                {% if form.tipo.errors %}
                                    <div class="text-danger small">{{ form.tipo.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Raça</label>
                                {{ form.raca }}
                                {% if form.raca.errors %}
                                    <div class="text-danger small">{{ form.raca.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Cor</label>
                                {{ form.cor }}
                                {% if form.cor.errors %}
                                    <div class="text-danger small">{{ form.cor.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Sexo</label>
                                {{ form.sexo }}
                                {% if form.sexo.errors %}
                                    <div class="text-danger small">{{ form.sexo.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Porte</label>
                                {{ form.porte }}
                                {% if form.porte.errors %}
                                    <div class="text-danger small">{{ form.porte.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Idade (anos)</label>
                                {{ form.idade_aproximada }}
                                {% if form.idade_aproximada.errors %}
                                    <div class="text-danger small">{{ form.idade_aproximada.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- UPLOAD CUSTOMIZADO EM PORTUGUÊS -->
                    <div class="mb-3">
                        <label class="form-label">
                            {% if animal.foto %}
                                Alterar Foto
                            {% else %}
                                Adicionar Foto
                            {% endif %}
                        </label>
                        <div class="custom-file-upload">
                            <input type="file" name="foto" id="id_foto" class="custom-file-input" accept="image/*" onchange="updateFileName(this)">
                            <label for="id_foto" class="custom-file-label">
                                <span class="file-button">
                                    <i class="fas fa-camera me-2"></i>
                                    {% if animal.foto %}
                                        Alterar Foto
                                    {% else %}
                                        Escolher Foto
                                    {% endif %}
                                </span>
                                <span class="file-text" id="file-info">
                                    {% if animal.foto %}
                                        Foto atual mantida
                                    {% else %}
                                        Nenhuma foto selecionada
                                    {% endif %}
                                </span>
                            </label>
                        </div>
                        <small class="form-text text-muted">
                            {% if animal.foto %}
                                Deixe em branco para manter a foto atual. 
                            {% endif %}
                            Formatos aceitos: JPG, PNG, GIF (máximo 5MB)
                        </small>
                        {% if form.foto.errors %}
                            <div class="text-danger small">{{ form.foto.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Características</label>
                        {{ form.caracteristicas }}
                        {% if form.caracteristicas.errors %}
                            <div class="text-danger small">{{ form.caracteristicas.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Microchip</label>
                        {{ form.microchip }}
                        {% if form.microchip.errors %}
                            <div class="text-danger small">{{ form.microchip.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                {{ form.vacinado }}
                                <label class="form-check-label" for="{{ form.vacinado.id_for_label }}">
                                    Vacinado
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                {{ form.castrado }}
                                <label class="form-check-label" for="{{ form.castrado.id_for_label }}">
                                    Castrado
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Observações</label>
                        {{ form.observacoes }}
                        {% if form.observacoes.errors %}
                            <div class="text-danger small">{{ form.observacoes.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <a href="{% url 'meus_animais' %}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-arrow-left me-1"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-warning text-dark">
                            <i class="fas fa-save me-1"></i>Salvar Alterações
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
/* CSS para upload customizado */
.custom-file-upload {
    position: relative;
    display: inline-block;
    width: 100%;
}

.custom-file-input {
    position: absolute;
    left: -9999px;
    opacity: 0;
}

.custom-file-label {
    display: flex;
    align-items: center;
    padding: 0.375rem 0.75rem;
    margin-bottom: 0;
    font-weight: 400;
    line-height: 1.5;
    color: #495057;
    background-color: #fff;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    width: 100%;
}

.custom-file-label:hover {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.file-button {
    display: inline-flex;
    align-items: center;
    padding: 0.375rem 0.75rem;
    margin-right: 0.75rem;
    font-weight: 500;
    color: #fff;
    background-color: #ffc107;
    border-radius: 0.25rem;
    border: none;
    cursor: pointer;
    transition: background-color 0.15s ease-in-out;
    white-space: nowrap;
}

.file-button:hover {
    background-color: #e0a800;
}

.file-text {
    color: #6c757d;
    font-style: italic;
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.file-text.has-file {
    color: #28a745;
    font-style: normal;
    font-weight: 500;
}

/* Responsividade */
@media (max-width: 576px) {
    .custom-file-label {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
        padding: 0.5rem;
    }
    
    .file-button {
        margin-right: 0;
        margin-bottom: 0.5rem;
        justify-content: center;
    }
    
    .file-text {
        text-align: center;
    }
}

/* Ocultar o input original do Django */
#id_foto {
    display: none !important;
}
</style>

<script>
function updateFileName(input) {
    const fileInfo = document.getElementById('file-info');
    
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const fileName = file.name;
        const fileSize = (file.size / 1024 / 1024).toFixed(2); // MB
        
        // Validar tamanho (5MB máximo)
        if (file.size > 5 * 1024 * 1024) {
            alert('A foto deve ter no máximo 5MB');
            input.value = '';
            fileInfo.innerHTML = '{% if animal.foto %}Foto atual mantida{% else %}Nenhuma foto selecionada{% endif %}';
            fileInfo.className = 'file-text';
            return;
        }
        
        // Validar tipo
        if (!file.type.startsWith('image/')) {
            alert('Por favor, selecione apenas arquivos de imagem');
            input.value = '';
            fileInfo.innerHTML = '{% if animal.foto %}Foto atual mantida{% else %}Nenhuma foto selecionada{% endif %}';
            fileInfo.className = 'file-text';
            return;
        }
        
        fileInfo.innerHTML = `<i class="fas fa-check-circle me-1"></i>${fileName} (${fileSize} MB)`;
        fileInfo.className = 'file-text has-file';
    } else {
        fileInfo.innerHTML = '{% if animal.foto %}Foto atual mantida{% else %}Nenhuma foto selecionada{% endif %}';
        fileInfo.className = 'file-text';
    }
}

// Garantir que o campo funcione corretamente
document.addEventListener('DOMContentLoaded', function() {
    // Ocultar o input original do Django se ainda estiver visível
    const originalInput = document.querySelector('input[name="foto"]:not(.custom-file-input)');
    if (originalInput) {
        originalInput.style.display = 'none';
    }
});
</script>
{% endblock %}